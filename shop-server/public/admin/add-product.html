<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }

      h2 {
        margin-bottom: 15px;
      }

      form {
        display: flex;
        flex-direction: column;
        width: 320px;
        gap: 12px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      label {
        font-weight: bold;
      }

      input,
      textarea,
      button {
        padding: 8px;
        font-size: 14px;
      }

      button {
        cursor: pointer;
      }

      #previewBox {
        margin-top: 10px;
      }

      #preview {
        max-width: 200px;
        display: none;
        border: 1px solid #ccc;
        padding: 5px;
        border-radius: 4px;
      }
      .error {
        color: #d80000;
        font-size: 13px;
        margin-top: -5px;
        margin-bottom: 5px;
        display: none;
      }

      input.error-field,
      textarea.error-field {
        border: 2px solid #d80000;
        background: #ffe5e5;
      }
    </style>
  </head>
  <body>
    <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>

    <form id="productForm">
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
      <select id="category">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
        <option value="phones">üì± –¢–µ–ª–µ—Ñ–æ–Ω—ã</option>
        <option value="laptops">üíª –ù–æ—É—Ç–±—É–∫–∏</option>
        <option value="audio">üéß –ê—É–¥–∏–æ</option>
        <option value="watches">‚åö –ß–∞—Å—ã</option>
        <option value="consoles">–ü—Ä–∏—Å—Ç–∞–≤–∫–∏</option>
      </select>
      <div class="error" id="err-category"></div>

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
      <input type="text" id="title" required />
      <div class="error" id="err-title"></div>

      <label>–¶–µ–Ω–∞:</label>
      <input type="number" id="price" step="0.01" required />
      <div class="error" id="err-title"></div>

      <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
      <textarea id="description" required></textarea>
      <div class="error" id="err-title"></div>

      <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
      <input type="file" id="image" accept="image/*" />
      <div class="error" id="err-title"></div>

      <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
      <div id="previewBox">
        <img id="preview" />
      </div>

      <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
      <input type="hidden" id="image_url" />

      <button type="button" id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
      <button type="submit">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
    </form>

    <script>
      // üì§ –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ö–ê–†–¢–ò–ù–ö–ò
      document.getElementById("image").addEventListener("change", (event) => {
        const file = event.target.files[0];
        const preview = document.getElementById("preview");

        if (file) {
          preview.src = URL.createObjectURL(file);
          preview.style.display = "block";
        }
      });

      // üì§ –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–ê –ù–ê –°–ï–†–í–ï–†
      document
        .getElementById("uploadBtn")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("image");
          const file = fileInput.files[0];

          if (!file) {
            alert("–†–æ–¥–Ω–æ–π, –≤—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É!");
            return;
          }

          const formData = new FormData();
          formData.append("image", file);

          const response = await fetch("/api/products/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.url) {
            document.getElementById("image_url").value = data.url;
            alert("–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! ‚ù§");
          } else {
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ");
          }
        });

      // ‚ûï –°–û–ó–î–ê–ù–ò–ï –¢–û–í–ê–†–ê
      document
        .getElementById("productForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const title = document.getElementById("title").value.trim();
          const price = document.getElementById("price").value;
          const description = document
            .getElementById("description")
            .value.trim();
          const image_url = document.getElementById("image_url").value;

          let isValid = true;

          // ---- –ù–∞–∑–≤–∞–Ω–∏–µ
          if (!title) {
            showError("title", "err-title", "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞");
            isValid = false;
          } else {
            clearError("title", "err-title");
          }

          // ---- –¶–µ–Ω–∞
          if (!price || price <= 0) {
            showError("price", "err-price", "–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0");
            isValid = false;
          } else {
            clearError("price", "err-price");
          }

          // ---- –û–ø–∏—Å–∞–Ω–∏–µ
          if (!description) {
            showError("description", "err-desc", "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ");
            isValid = false;
          } else {
            clearError("description", "err-desc");
          }

          // ---- –ö–∞—Ç–µ–≥–æ—Ä–∏—è
          if (!category) {
            showError("category", "err-category", "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é");
            isValid = false;
          } else {
            clearError("category", "err-category");
          }

          // ---- –§–æ—Ç–æ
          if (!image_url) {
            showError("image", "err-image", "–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");
            isValid = false;
          } else {
            clearError("image", "err-image");
          }

          if (!isValid) {
            return; // —Å—Ç–æ–ø, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
          }

          const body = {
            title,
            price,
            description,
            image_url,
            category,
          };

          const response = await fetch("/api/products", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const data = await response.json();
          alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω ‚ù§");

          console.log("–°–æ–∑–¥–∞–Ω —Ç–æ–≤–∞—Ä:", data);
        });

      function showError(inputId, errId, message) {
        const input = document.getElementById(inputId);
        const err = document.getElementById(errId);

        input.classList.add("error-field");
        err.innerText = message;
        err.style.display = "block";
      }

      function clearError(inputId, errId) {
        const input = document.getElementById(inputId);
        const err = document.getElementById(errId);

        input.classList.remove("error-field");
        err.style.display = "none";
      }
    </script>
  </body>
</html>
